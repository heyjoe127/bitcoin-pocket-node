# Desktop Port: Compose Multiplatform

## Summary

Run the same Pocket Node app on desktop (Linux, macOS, Windows) using Jetpack Compose Multiplatform. Same UI, same flow, same codebase. Not a CLI tool that happens to run bitcoind. The phone app experience in a desktop window.

## Why Compose Multiplatform

The app is already Kotlin + Jetpack Compose. Compose Multiplatform (by JetBrains) runs the same Compose UI code natively on desktop via JVM. This is not a rewrite. It's a refactor into shared and platform-specific modules.

Alternatives considered:
- **CLI tool:** Loses the visual experience that makes Pocket Node approachable
- **Electron/Tauri wrapper:** Separate codebase, different language, maintenance burden
- **Android emulator:** Heavy, poor UX, defeats the simplicity
- **Waydroid:** Linux-only, niche

Compose Multiplatform means one Kotlin codebase, two targets. UI code is literally identical.

## Architecture

```
bitcoin-pocket-node/
├── shared/                          # Compose Multiplatform shared module
│   ├── commonMain/
│   │   ├── ui/                      # All Compose screens (moved from app/)
│   │   │   ├── NodeStatusScreen.kt
│   │   │   ├── SetupChecklistScreen.kt
│   │   │   ├── MempoolScreen.kt
│   │   │   ├── ConnectWalletScreen.kt
│   │   │   └── ...
│   │   ├── rpc/
│   │   │   └── BitcoinRpcClient.kt
│   │   ├── ssh/
│   │   │   └── SshUtils.kt
│   │   ├── oracle/
│   │   │   └── UTXOracle.kt
│   │   ├── snapshot/
│   │   │   ├── ChainstateManager.kt
│   │   │   └── BlockFilterManager.kt
│   │   └── util/
│   │       ├── BinaryExtractor.kt
│   │       └── ConfigGenerator.kt
│   ├── androidMain/                 # Android-specific implementations
│   │   ├── service/
│   │   │   ├── BitcoindService.kt   # Foreground service
│   │   │   ├── BatteryMonitor.kt
│   │   │   └── BootReceiver.kt
│   │   └── network/
│   │       └── NetworkMonitor.kt    # Cellular/VPN detection
│   └── desktopMain/                 # Desktop-specific implementations
│       ├── service/
│       │   └── DesktopBitcoindManager.kt  # Process management
│       ├── network/
│       │   └── DesktopNetworkMonitor.kt   # Simplified (WiFi only)
│       └── main.kt                  # Desktop entry point + window
├── app/                             # Android app module (thin shell)
│   └── src/main/
│       ├── AndroidManifest.xml
│       └── MainActivity.kt
└── desktop/                         # Desktop app module (thin shell)
    └── src/main/
        └── Main.kt                  # Window setup, tray icon
```

## What Moves to Shared

Almost everything. The key insight is that the app's core logic has no Android dependencies:

| Component | Android dependency? | Shared? |
|---|---|---|
| All Compose UI screens | No (pure Compose) | Yes |
| BitcoinRpcClient | No (HTTP + JSON) | Yes |
| SshUtils | No (JSch library) | Yes |
| UTXOracle | No (pure math + RPC) | Yes |
| ChainstateManager | No (SSH + RPC) | Yes |
| BlockFilterManager | No (SSH + RPC) | Yes |
| BinaryExtractor | Minor (asset extraction) | Yes, with expect/actual |
| ConfigGenerator | No (string building) | Yes |
| BitcoindService | Yes (foreground service) | No, platform-specific |
| BatteryMonitor | Yes (BatteryManager) | No, desktop removes it |
| NetworkMonitor | Yes (ConnectivityManager) | No, platform-specific |
| BootReceiver | Yes (BroadcastReceiver) | No, platform-specific |

## Platform-Specific: Desktop Service Layer

### DesktopBitcoindManager.kt

Replaces Android's foreground service with simple JVM process management:

```kotlin
class DesktopBitcoindManager {
    private var process: Process? = null

    fun start(version: BitcoinVersion, dataDir: Path) {
        val binary = getBinaryPath(version)  // x86_64 binary
        val config = ConfigGenerator.generate(
            dataDir = dataDir,
            dbcache = 2048,        // Desktop can afford it
            maxmempool = 300,      // Full mempool
            maxconnections = 12,   // Serve the network
            prune = 2048
        )
        writeConfig(dataDir, config)

        process = ProcessBuilder(binary.toString(), "-datadir=${dataDir}")
            .redirectErrorStream(true)
            .start()
    }

    fun stop() {
        // Graceful shutdown via RPC stop command
        rpcClient.call("stop")
        process?.waitFor(30, TimeUnit.SECONDS)
        if (process?.isAlive == true) process?.destroyForcibly()
    }

    val isRunning: StateFlow<Boolean>  // Poll process.isAlive
}
```

### Desktop Configuration Differences

```ini
# Desktop bitcoin.conf (generated by ConfigGenerator)
server=1
prune=2048
listen=0
maxconnections=12          # More generous than phone (4)
maxmempool=300             # Full mempool (vs 50 MB)
dbcache=2048               # Use available RAM (vs 256 MB)
rpcbind=127.0.0.1
rpcallowip=127.0.0.1
rpcuser=pocketnode
rpcpassword=<generated>
disablewallet=1
```

All ports remain localhost-only. Same security model as the phone.

### Desktop Network Monitor

Simplified. No cellular detection, no metered network logic, no VPN heuristics:

```kotlin
class DesktopNetworkMonitor {
    val isConnected: StateFlow<Boolean>  // Simple connectivity check
    // No data budgets, no WiFi/cellular split
    // Desktop assumed to be on unmetered connection
}
```

### Autostart

| Platform | Mechanism |
|---|---|
| Linux | systemd user service or XDG autostart |
| macOS | launchd plist in ~/Library/LaunchAgents |
| Windows | Startup folder shortcut or registry |

Optional. User toggles from the same dashboard setting as the phone's "Start on boot."

### Desktop Window

```kotlin
// desktop/src/main/Main.kt
fun main() = application {
    val windowState = rememberWindowState(
        width = 420.dp,    // Phone-like width
        height = 800.dp
    )
    Window(
        onCloseRequest = ::exitApplication,
        state = windowState,
        title = "Bitcoin Pocket Node"
    ) {
        // Same PocketNodeApp() composable as Android
        PocketNodeApp()
    }
}
```

Window defaults to phone-like proportions. Freely resizable and draggable to simulate different device sizes:

- **Narrow (< 550dp):** Single-pane phone layout
- **Wide (≥ 550dp):** Dual-pane foldable/tablet layout (existing BoxWithConstraints breakpoint)
- **Full desktop width:** Same dual-pane, more breathing room

This doubles as a live device preview. Drag the window narrow to see exactly what a phone user sees. Drag it wide to see the foldable experience. The responsive layout is already built from the phone app's foldable support. No new code needed.

System tray icon for background operation (minimize to tray, show status).

## Binary Distribution

Desktop bundles x86_64 bitcoind binaries, same version selection:

| Implementation | Android (ARM64) | Desktop (x86_64) |
|---|---|---|
| Core 28.1 | libbitcoind_v28_1.so | bitcoind_v28_1 |
| Core 30 | libbitcoind_v30.so | bitcoind_v30 |
| Knots 29.3 | libbitcoind_knots.so | bitcoind_knots |
| Knots BIP 110 | libbitcoind_knots_bip110.so | bitcoind_knots_bip110 |

Cross-compilation for x86_64 Linux/macOS/Windows using the same depends system. macOS needs the SDK; Windows needs mingw-w64.

Distribution:
- **Linux:** AppImage or Flatpak (bundles JVM + binaries)
- **macOS:** .app bundle in DMG
- **Windows:** Installer or portable ZIP

## Scope: What's NOT in v1

- No Tor integration (same as phone, future roadmap)
- No LND/Lightning (Zeus is Android-only; desktop Lightning is a separate project)
- No GUI installer for donor node setup scripts (use existing SSH wizard in-app)
- No auto-update mechanism (manual download for now)

## Migration Path

### Phase 1: Project restructure (1 week)
- Add Compose Multiplatform Gradle plugin
- Create `shared/commonMain` module
- Move UI screens and business logic to shared
- Define `expect/actual` interfaces for platform-specific code
- Verify Android app still builds and works identically

### Phase 2: Desktop target (1 week)
- Implement DesktopBitcoindManager
- Implement desktop entry point and window
- Cross-compile x86_64 bitcoind for Linux (start with one platform)
- Test chainstate copy from Umbrel to desktop

### Phase 3: Polish (0.5-1 week)
- System tray integration
- Desktop notifications (block synced, peer count changes)
- macOS and Windows builds
- README and documentation updates

**Total estimated effort:** 2-3 weeks for a working desktop build.

## The Pitch

> Same app. Same UI. Same sovereign experience. Phone or desktop, one codebase. Your Bitcoin node runs wherever you do. Bootstrap from your home node in 20 minutes on any platform. Pick your consensus rules with one tap.

The desktop port isn't a separate product. It's proof that Pocket Node's architecture is platform-agnostic. The chainstate copy, version selection, UTXOracle, and setup flow work everywhere. The phone just happened to be first.
